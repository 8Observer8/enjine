// -----------------------------------------------
// - Enjine - HTML5 Canvas game library
// - Copyright Rob Kleffner 2011
// - Updated on 7/8/2011
// -----------------------------------------------
var $e={Drawable:function(){this.zOrder=0}};$e.Drawable.prototype={draw:function(){}};$e.Vector2=function(a,b){this.x=a;this.y=b};
$e.Vector2.prototype={equals:function(a){return this.x===a.x&&this.y===a.y},dot:function(a){return this.x*a.x+this.y*a.y},len:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var a=Math.sqrt(this.x*this.x+this.y*this.y);this.x/=a;this.y/=a;return this},add:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a){this.x-=a.x;this.y-=a.y;return this},scale:function(a){this.x*=a;this.y*=a;return this},mul:function(a){this.x*=a.x;this.y*=a.y;return this},div:function(a){this.x/=
a.x;this.y/=a.y;return this}};$e.Vector2.zero=new $e.Vector2(0,0);$e.Vector2.one=new $e.Vector2(1,1);$e.Vector2.unitX=new $e.Vector2(1,0);$e.Vector2.unitY=new $e.Vector2(0,1);$e.Vector2.dot=function(a,b){return a.x*b.x+a.y*b.y};$e.Vector2.len=function(a){return Math.sqrt(a.x*a.x+a.y*a.y)};$e.Vector2.add=function(a,b){return new $e.Vector2(a.x+b.x,a.y+b.y)};$e.Vector2.sub=function(a,b){return new $e.Vector2(a.x-b.x,a.y-b.y)};$e.Vector2.scale=function(a,b){return new $e.Vector2(a.x*b,a.y*b)};
$e.Vector2.mul=function(a,b){return new $e.Vector2(a.x*b.x,a.y*b.y)};$e.Vector2.div=function(a,b){return new $e.Vector2(a.x/b.x,a.y/b.y)};$e.Camera=function(){this.y=this.x=0};$e.Keys={a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:80,left:37,up:38,right:39,down:40};
$e.Keyboard={pressed:[],initialize:function(){var a=this;document.onkeydown=function(b){a.keyDownEvent(b)};document.onkeyup=function(b){a.keyUpEvent(b)}},isKeyDown:function(a){if(this.pressed[a]!==null)return this.pressed[a];return!1},keyDownEvent:function(a){this.pressed[a.keyCode]=!0},keyUpEvent:function(a){this.pressed[a.keyCode]=!1}};$e.GameTimer=function(){this.framesPerSecond=1E3/30;this.lastTime=0;this.updateObject=this.intervalFunc=null};
$e.GameTimer.prototype={start:function(){var a=this;this.lastTime=(new Date).getTime();this.intervalFunc=setInterval(function(){a.tick()},this.framesPerSecond)},tick:function(){var a=(new Date).getTime(),b=(a-this.lastTime)/1E3;if(this.updateObject!==null)this.lastTime=a,this.updateObject.update(b)},stop:function(){clearInterval(this.intervalFunc)}};$e.GameCanvas=function(){this.betterBuffer=this.backBufferContext2D=this.backBuffer=this.context2D=this.canvas=null;this.autoResolutionMode=!1;return this};
$e.GameCanvas.prototype={initialize:function(a,b,c){this.canvas=document.getElementById(a);this.context2D=this.canvas.getContext("2d");this.backBuffer=document.createElement("canvas");this.backBuffer.width=b;this.backBuffer.height=c;this.betterBuffer=this.backBufferContext2D=this.backBuffer.getContext("2d");this.betterBuffer.width=this.backBuffer.width;this.betterBuffer.height=this.backBuffer.height;return this},beginDraw:function(){this.backBufferContext2D.clearRect(0,0,this.backBuffer.width,this.backBuffer.height);
this.context2D.clearRect(0,0,this.canvas.width,this.canvas.height)},endDraw:function(){this.context2D.drawImage(this.backBuffer,0,0,this.backBuffer.width,this.backBuffer.height,0,0,this.canvas.width,this.canvas.height)},fullScreen:function(a){this.autoResolutionMode=a;this.changeCanvasSize(window.innerWidth,window.innerHeight);var b=this;window.onresize=function(){document.body.style.margin="0";document.body.style.padding="0";b.canvas.width=window.innerWidth;b.canvas.height=window.innerHeight;if(b.autoResolutionMode)b.backBuffer.width=
b.canvas.width,b.backBuffer.height=b.canvas.height,b.betterBuffer.width=b.backBuffer.width,b.betterBuffer.height=b.backBuffer.height}},changeCanvasResolution:function(a,b){this.autoResolutionMode=!1;this.backBuffer.width=a;this.backBuffer.height=b;this.betterBuffer.width=this.backBuffer.width;this.betterBuffer.height=this.backBuffer.height},changeCanvasSize:function(a,b){this.canvas.width=a;this.canvas.height=b;window.onresize=null;if(this.autoResolutionMode)this.backBuffer.width=this.canvas.width,
this.backBuffer.height=this.canvas.height,this.betterBuffer.width=this.backBuffer.width,this.betterBuffer.height=this.backBuffer.height}};$e.Buttons={MouseLeft:0,MouseRight:2,MouseWheel:1};
$e.Mouse={x:0,y:0,pressed:[],element:null,containsMouse:!1,initialize:function(a){var b=this;this.element=a;a.onmousedown=function(a){b.pressed[a.button]=!0};a.onmouseup=function(a){b.pressed[a.button]=!1};a.onmousemove=function(a){b.mouseMoveEvent(a)};a.onmouseover=function(){b.containsMouse=!0};a.onmouseout=function(){b.containsMouse=!1;this.y=this.x=-1}},isButtonDown:function(a){if(this.pressed[a]!==null)return this.pressed[a];return!1},mouseMoveEvent:function(a){this.x=a.pageX;this.y=a.pageY;
a=this.element;if(a.offsetParent){do this.x-=a.offsetLeft,this.y-=a.offsetTop;while(a=a.offsetParent)}}};$e.DrawableManager=function(){this.unsorted=!0;this.objects=[]};
$e.DrawableManager.prototype={add:function(a){this.objects.push(a);this.unsorted=!0;return this},addRange:function(a){this.objects=this.objects.concat(a);this.unsorted=!0;return this},clear:function(){this.objects.splice(0,this.objects.length);return this},contains:function(a){for(var b=this.objects.length;b--;)if(this.objects[b]===a)return!0;return!1},remove:function(a){this.objects.splice(this.objects.indexOf(a),1);return this},removeAt:function(a){this.objects.splice(a,1);return this},removeRange:function(a,
b){this.objects.splice(a,b);return this},removeList:function(a){for(var b=0,c=0,c=0;c<a.length;)for(b=0;b<this.objects.length;b++)if(this.objects[b]===a[c]){this.objects.splice(b,1);a.splice(c,1);c--;break}return this},update:function(a){for(var b=0,b=0;b<this.objects.length;b++)this.objects[b].update&&this.objects[b].update(a)},draw:function(a,b){var c=0;if(this.unsorted)this.unsorted=!1,this.objects.sort(function(a,b){return a.zOrder-b.zOrder});for(c=0;c<this.objects.length;c++)this.objects[c].draw&&
this.objects[c].draw(a,b)}};
$e.Resources={images:{},sounds:{},destroy:function(){delete this.images;delete this.sounds;return this},addImage:function(a,b){var c=new Image;this.images[a]=c;c.src=b;return this},addImages:function(a){for(var b=0,c=null,b=0;b<a.length;b++)c=new Image,this.images[a[b].name]=c,c.src=a[b].src;return this},clearImages:function(){delete this.images;this.images={};return this},removeImage:function(a){delete this.images[a];return this},addSound:function(a,b,c){var d=0;this.sounds[a]=[];this.sounds[a].index=
0;c||(c=3);for(d=0;d<c;d++)this.sounds[a][d]=new Audio(b);return this},clearSounds:function(){delete this.sounds;this.sounds={};return this},removeSound:function(a){delete this.sounds[a];return this},playSound:function(a,b){if(this.sounds[a].index>=this.sounds[a].length)this.sounds[a].index=0;b&&this.sounds[a][this.sounds[a].index].addEventListener("ended",this.loopCallback,!1);this.sounds[a][this.sounds[a].index++].play();return this.sounds[a].index},pauseChannel:function(a,b){this.sounds[a][b].paused||
this.sounds[a][b].pause();return this},pauseSound:function(a){for(var b=0,b=0;b<this.sounds[a].length;b++)this.sounds[a][b].paused||this.sounds[a][b].pause();return this},resetChannel:function(a,b){this.sounds[a][b].currentTime=0;this.stopLoop(a,b);return this},resetSound:function(a){for(var b=0,b=0;b<this.sounds[a].length;b++)this.sounds[a].currentTime=0,this.stopLoop(a,b);return this},stopLoop:function(a,b){this.sounds[a][b].removeEventListener("ended",this.loopCallback,!1)},loopCallback:function(){this.currentTime=
-1;this.play()}};$e.Sprite=function(){this.y=this.x=0;this.yPivot=this.xPivot=0.5;this.angle=0;this.yScale=this.xScale=1;this.image=null};$e.Sprite.prototype=new $e.Drawable;$e.Sprite.prototype.draw=function(a,b){a.save();a.translate(this.x-b.x,this.y-b.y);a.rotate(this.angle);a.scale(this.xScale,this.yScale);a.drawImage(this.image,-this.image.width*this.xPivot,-this.image.height*this.yPivot);a.restore()};$e.FrameSprite=function(){this.frameHeight=this.frameWidth=this.frameY=this.frameX=0};
$e.FrameSprite.prototype=new $e.Sprite;$e.FrameSprite.prototype.draw=function(a,b){a.save();a.translate(this.x-b.x,this.y-b.y);a.rotate(this.angle);a.scale(this.xScale,this.yScale);a.drawImage(this.image,this.frameX,this.frameY,this.frameWidth,this.frameHeight,-this.frameWidth*this.xPivot,-this.frameHeight*this.yPivot,this.frameWidth,this.frameHeight);a.restore()};
$e.AnimationSequence=function(a,b,c,d){this.startRow=a;this.startColumn=b;this.endRow=c;this.endColumn=d;this.singleFrame=!1;if(this.startRow===this.endRow&&this.startColumn===this.endColumn)this.singleFrame=!0};$e.AnimatedSprite=function(){this.lastElapsed=0;this.framesPerSecond=0.05;this.currentSequence=null;this.looping=this.playing=!1;this.sequences={}};$e.AnimatedSprite.prototype=new $e.FrameSprite;
$e.AnimatedSprite.prototype.update=function(a){var b=!1;if(!this.currentSequence.singleFrame&&this.playing&&(this.lastElapsed-=a,!(this.lastElapsed>0))){this.lastElapsed=this.framesPerSecond;this.frameX+=this.frameWidth;if(this.frameX>this.image.width-this.frameWidth&&(this.frameX=0,this.frameY+=this.frameHeight,this.frameY>this.image.height-this.frameHeight))this.frameY=0;this.frameX>this.currentSequence.endColumn*this.frameWidth&&this.frameY===this.currentSequence.endRow*this.frameHeight?b=!0:this.frameX===
0&&this.frameY>this.currentSequence.endRow*this.frameHeight&&(b=!0);if(b)this.looping?(this.frameX=this.currentSequence.startColumn*this.frameWidth,this.frameY=this.currentSequence.startRow*this.frameHeight):this.playing=!1}};$e.AnimatedSprite.prototype.playSequence=function(a,b){this.playing=!0;this.looping=b;this.currentSequence=this.sequences["seq_"+a];this.frameX=this.currentSequence.startColumn*this.frameWidth;this.frameY=this.currentSequence.startRow*this.frameHeight;return this};
$e.AnimatedSprite.prototype.stopLooping=function(){this.looping=!1;return this};$e.AnimatedSprite.prototype.stopPlaying=function(){this.playing=!1;return this};$e.AnimatedSprite.prototype.setFrameWidth=function(a){this.frameWidth=a;return this};$e.AnimatedSprite.prototype.setFrameHeight=function(a){this.frameHeight=a;return this};$e.AnimatedSprite.prototype.setColumnCount=function(a){this.frameWidth=this.image.width/a;return this};
$e.AnimatedSprite.prototype.setRowCount=function(a){this.frameHeight=this.image.height/a;return this};$e.AnimatedSprite.prototype.addSequence=function(a,b){this.sequences["seq_"+a]=b;return this};$e.AnimatedSprite.prototype.addNewSequence=function(a,b,c,d,e){this.sequences["seq_"+a]=new $e.AnimationSequence(b,c,d,e);return this};$e.AnimatedSprite.prototype.deleteSequence=function(a){this.sequences["seq_"+a]!==null&&delete this.sequences["seq_"+a];return this};
$e.AnimatedSprite.prototype.clearSequences=function(){delete this.sequences;this.sequences={};return this};$e.SpriteFont=function(a,b,c,d){this.image=a;this.letters=d;this.letterWidth=b;this.letterHeight=c;this.lineHeight=this.letterSpacing=0;this.strings=[]};$e.SpriteFont.prototype=new $e.Drawable;$e.SpriteFont.prototype.addString=function(a,b,c){this.strings.push({string:a,x:b,y:c});return this};$e.SpriteFont.prototype.removeString=function(a){this.strings.splice(a,1);return this};
$e.SpriteFont.prototype.draw=function(a,b){for(var c=0,d=0,e=null,f=0,g=0,h=0,f=0;f<this.strings.length;f++){e=this.strings[f];g=e.x;h=e.y;for(d=0;d<e.string.length;d++)c=e.string.charCodeAt(d),c===10?(h+=this.letterHeight+this.lineSpacing,g=e.x):(a.drawImage(this.image,this.letters[c].x,this.letters[c].y,this.letterWidth,this.letterHeight,g-b.x,h-b.y,this.letterWidth,this.letterHeight),g+=this.letterWidth+this.letterSpacing)}};
$e.GameStateContext=function(a){this.state=null;if(a!==null)this.state=a,this.state.enter()};$e.GameStateContext.prototype={changeState:function(a){this.state!==null&&this.state.exit();this.state=a;this.state.enter()},update:function(a){this.state.checkForChange(this);this.state.update(a)},draw:function(a){this.state.draw(a)}};$e.GameState=function(){};$e.GameState.prototype={enter:function(){},exit:function(){},update:function(){},draw:function(){},checkForChange:function(){}};
$e.Collideable=function(a,b,c,d){this.base=a;this.x=a.x;this.y=a.y;this.width=b;this.height=c;this.collisionEvent=d!==null?d:function(){}};$e.Collideable.prototype={update:function(){this.x=this.base.x;this.y=this.base.y},checkCollision:function(a){!(this.y+this.height<a.y)&&!(this.y>a.y+a.height)&&!(this.x+this.width<a.x)&&!(this.x>a.x+a.width)&&(this.collisionEvent(a),a.collisionEvent(this))}};$e.Application=function(){this.stateContext=this.timer=this.canvas=null};
$e.Application.prototype={update:function(a){this.stateContext.update(a);this.canvas.beginDraw();this.stateContext.draw(this.canvas.betterBuffer);this.canvas.endDraw()},initialize:function(a,b,c,d){this.canvas=new $e.GameCanvas;this.timer=new $e.GameTimer;$e.Keyboard.initialize();$e.Mouse.initialize(document.getElementById(a));this.canvas.initialize(a,c,d);this.timer.updateObject=this;this.stateContext=new $e.GameStateContext(b);this.timer.start()}};